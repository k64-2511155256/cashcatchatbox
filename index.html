<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket Pal</title>
    <!-- T·∫£i Tailwind CSS ƒë·ªÉ ƒë·∫£m b·∫£o phong c√°ch hi·ªán ƒë·∫°i v√† d·ªÖ d√†ng t√πy ch·ªânh -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Thi·∫øt l·∫≠p font Inter cho to√†n b·ªô ·ª©ng d·ª•ng */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* M√†u n·ªÅn nh·∫π nh√†ng */
        }
        /* M√†u ch·ªß ƒë·∫°o: Xanh d∆∞∆°ng (Blue) */
        .pocket-pal-blue {
            background-color: #3b82f6; /* Blue-500 */
        }
        .pocket-pal-text-blue {
            color: #3b82f6;
        }
        .btn-primary {
            background-color: #3b82f6;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Blue-600 */
        }
        /* ƒê·ªãnh d·∫°ng c√¢u h·ªèi: In ƒë·∫≠m */
        .question-text {
            font-weight: 700;
        }
        /* ƒê·ªãnh d·∫°ng ti√™u ƒë·ªÅ: In hoa v√† In ƒë·∫≠m */
        .title-text {
            font-weight: 900;
        }
        /* ·∫®n thanh cu·ªôn tr√™n m·ªôt s·ªë tr√¨nh duy·ªát, ∆∞u ti√™n thi·∫øt k·∫ø s·∫°ch */
        .chat-area {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .chat-area::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- KHUNG CHATBOX CH√çNH -->
    <div id="pocketPal" class="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden flex flex-col h-[80vh] min-h-[500px]">

        <!-- HEADER -->
        <header class="pocket-pal-blue text-white p-4 shadow-md">
            <h1 class="text-xl title-text text-uppercase text-center">
                POCKET PAL
            </h1>
        </header>

        <!-- KHU V·ª∞C CHAT -->
        <main id="chatArea" class="chat-area flex-grow p-4 space-y-4 overflow-y-auto">
            <!-- N·ªôi dung chat s·∫Ω ƒë∆∞·ª£c render t·∫°i ƒë√¢y -->
        </main>

        <!-- FOOTER / KHU V·ª∞C NH·∫¨P LI·ªÜU (T√πy theo tr·∫°ng th√°i) -->
        <footer id="inputArea" class="p-4 border-t border-gray-100 bg-gray-50">
            <!-- N√∫t b·∫•m/Input s·∫Ω ƒë∆∞·ª£c render t·∫°i ƒë√¢y -->
        </footer>

        <!-- Modal hi·ªÉn th·ªã k·∫øt qu·∫£ quiz (thay th·∫ø alert) -->
        <div id="resultModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 shadow-xl w-11/12 max-w-md">
                <h3 id="modalTitle" class="text-2xl font-bold mb-4 text-center pocket-pal-text-blue">K·∫æT LU·∫¨N T·ª™ POCKET PAL</h3>
                <p id="modalMessage" class="text-gray-700 text-center mb-6"></p>
                <div class="flex justify-center">
                    <button id="modalCloseBtn" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg">
                        Ho√†n t·∫•t
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- C·∫§U H√åNH V√Ä BI·∫æN TO√ÄN C·ª§C ---
        let appState = 'intro';
        let userSelection = {};
        let quizScore = 0;
        let quizMode = ''; 
        let currentQuizIndex = 0;
        const GOOGLE_SCRIPT_URL = 'YOUR_GOOGLE_APP_SCRIPT_URL_HERE'; 

        // --- D·ªÆ LI·ªÜU C√ÇU H·ªéI V√Ä ƒêI·ªÇM S·ªê ---
        const QUIZ_BUYING = [
            // Q1: Importance
            { q: "M√≥n ƒë·ªì n√†y ph·ª•c v·ª• m·ª•c ƒë√≠ch g√¨?",
              opts: [
                { text: "Nhu c·∫ßu sinh t·ªìn / thi·∫øt y·∫øu", scores: { tight: 3, save: 3, comfort: 3 } },
                { text: "H·ªçc t·∫≠p / c√¥ng vi·ªác (thi·∫øt y·∫øu)", scores: { tight: 2, save: 2, comfort: 2 } },
                { text: "Ti·ªán nghi / gi·∫£i tr√≠", scores: { tight: 0, save: -1, comfort: -1 } },
                { text: "S·ªü th√≠ch / xu h∆∞·ªõng / c·∫£m t√≠nh", scores: { tight: -2, save: -2, comfort: -2 } }
              ]
            },
            // Q2: Urgency
            { q: "B·∫°n c√≥ c·∫ßn n√≥ ngay b√¢y gi·ªù kh√¥ng?",
              opts: [
                { text: "C·∫ßn ngay, ·∫£nh h∆∞·ªüng vi·ªác h·ªçc/s·ª©c kh·ªèe", scores: { tight: 3, save: 2, comfort: 3 } },
                { text: "C√≥ th·ªÉ ch·ªù v√†i ng√†y", scores: { tight: 1, save: 1, comfort: 1 } },
                { text: "Kh√¥ng g·∫•p", scores: { tight: 0, save: 0, comfort: 0 } },
                { text: "Mua v√¨ sale / FOMO / s·ª£ h·∫øt h√†ng", scores: { tight: -3, save: -3, comfort: -2 } }
              ]
            },
            // Q3: Affordability
            { q: "Sau khi mua, s·ªë ti·ªÅn c√≤n l·∫°i c√≥ ƒë·ªß cho nhu c·∫ßu c∆° b·∫£n tu·∫ßn/th√°ng kh√¥ng?",
              opts: [
                { text: "D∆∞ r√µ r·ªát (v·∫´n an to√†n)", scores: { tight: 2, save: 3, comfort: 3 } },
                { text: "D∆∞ ƒë·ªß tho·∫£i m√°i", scores: { tight: 0, save: 0, comfort: 2 } }, // Th√™m cho Comfort
                { text: "V·ª´a ƒë·ªß (nh∆∞ng kh√¥ng ·∫£nh h∆∞·ªüng c∆° b·∫£n)", scores: { tight: 0, save: 0, comfort: 1 } },
                { text: "R·∫•t ch·∫≠t v·∫≠t", scores: { tight: -2, save: -2, comfort: -2 } },
                { text: "Kh√¥ng ƒë·ªß", scores: { tight: -3, save: -3, comfort: -3 } }
              ]
            },
            // Q4: Opportunity Cost
            { q: "N·∫øu b·∫°n mua m√≥n n√†y, b·∫°n s·∫Ω ph·∫£i b·ªè qua ƒëi·ªÅu g√¨?",
              opts: [
                { text: "Kh√¥ng b·ªè qua g√¨ quan tr·ªçng", scores: { tight: 2, save: 2, comfort: 3 } },
                { text: "M·ªôt kho·∫£n chi nh·ªè kh√°c", scores: { tight: 0, save: 0, comfort: 1 } },
                { text: "Ti·ªÅn ti·∫øt ki·ªám ho·∫∑c m·ª•c ti√™u l·ªõn", scores: { tight: -3, save: -3, comfort: -3 } }
              ]
            },
            // Q5: Emotional Trigger
            { q: "Quy·∫øt ƒë·ªãnh mua c·ªßa b·∫°n xu·∫•t ph√°t t·ª´ ƒëi·ªÅu g√¨?",
              opts: [
                { text: "Nhu c·∫ßu th·ª±c s·ª±", scores: { tight: 3, save: 2, comfort: 3 } },
                { text: "M·ªôt ph·∫ßn c·∫£m x√∫c", scores: { tight: -1, save: -1, comfort: 0 } },
                { text: "Ch·ªß y·∫øu c·∫£m x√∫c (bu·ªìn, ch√°n, stress, FOMO, peer pressure)", scores: { tight: -3, save: -3, comfort: -3 } }
              ]
            },
            // Q6: Frequency
            { q: "Trong th√°ng, b·∫°n ƒë√£ mua th·ª© t∆∞∆°ng t·ª± bao nhi√™u l·∫ßn?",
              opts: [
                { text: "0 l·∫ßn", scores: { tight: 2, save: 2, comfort: 3 } },
                { text: "1‚Äì2 l·∫ßn", scores: { tight: 0, save: 0, comfort: 2 } },
                { text: "3‚Äì4 l·∫ßn", scores: { tight: -2, save: -1, comfort: -1 } },
                { text: "4 l·∫ßn (ho·∫∑c nhi·ªÅu h∆°n 4 l·∫ßn)", scores: { tight: -3, save: -2, comfort: -3 } }
              ]
            },
            // Q7: Longevity & Usefulness
            { q: "B·∫°n s·∫Ω d√πng m√≥n ƒë·ªì n√†y trong bao l√¢u?",
              opts: [
                { text: "Tr√™n 6 th√°ng", scores: { tight: 3, save: 2, comfort: 3 } },
                { text: "V√†i tu·∫ßn ƒë·∫øn v√†i th√°ng", scores: { tight: 1, save: 1, comfort: 1 } },
                { text: "1‚Äì2 l·∫ßn ho·∫∑c v√†i ng√†y", scores: { tight: -3, save: -3, comfort: -3 } }
              ]
            },
            // Q8: Alternatives
            { q: "C√≥ l·ª±a ch·ªçn r·∫ª h∆°n ho·∫∑c mi·ªÖn ph√≠ kh√¥ng?",
              opts: [
                { text: "Kh√¥ng c√≥", scores: { tight: 2, save: 2, comfort: 3 } },
                { text: "C√≥ nh∆∞ng kh√¥ng ti·ªán", scores: { tight: 0, save: 0, comfort: 1 } },
                { text: "C√≥ l·ª±a ch·ªçn t∆∞∆°ng ƒë∆∞∆°ng r·∫ª h∆°n", scores: { tight: -1, save: -1, comfort: -1 } },
                { text: "C√≥ b·∫£n mi·ªÖn ph√≠ / m∆∞·ª£n ƒë∆∞·ª£c", scores: { tight: -3, save: -3, comfort: -3 } },
                { text: "Ch∆∞a t√¨m hi·ªÉu", scores: { tight: -2, save: -1, comfort: -1 } }
              ]
            },
            // Q9: Regret Prediction
            { q: "Tr·∫£i nghi·ªám tr∆∞·ªõc ƒë√¢y v·ªõi m√≥n t∆∞∆°ng t·ª±?",
              opts: [
                { text: "H√†i l√≤ng", scores: { tight: 2, save: 2, comfort: 3 } },
                { text: "B√¨nh th∆∞·ªùng", scores: { tight: 0, save: 0, comfort: 1 } },
                { text: "H·ªëi h·∫≠n / l√£ng ph√≠", scores: { tight: -3, save: -3, comfort: -3 } }
              ]
            },
            // Q10: Long-term Goal Alignment
            { q: "M√≥n ƒë·ªì n√†y ·∫£nh h∆∞·ªüng th·∫ø n√†o t·ªõi m·ª•c ti√™u t√†i ch√≠nh c·ªßa b·∫°n?",
              opts: [
                { text: "H·ªó tr·ª£ tr·ª±c ti·∫øp m·ª•c ti√™u", scores: { tight: 3, save: 3, comfort: 3 } },
                { text: "Kh√¥ng ·∫£nh h∆∞·ªüng", scores: { tight: 0, save: 0, comfort: 1 } },
                { text: "·∫¢nh h∆∞·ªüng x·∫•u / k√©o b·∫°n xa m·ª•c ti√™u", scores: { tight: -3, save: -3, comfort: -3 } }
              ]
            }
        ];

        // Khung ƒëi·ªÉm cho Quiz S·ª± ki·ªán (Branch 2.2)
        const QUIZ_EVENT = [
            // Q1: Connection
            { q: "Tham gia ho·∫°t ƒë·ªông n√†y gi√∫p b·∫°n k·∫øt n·ªëi t·ªët h∆°n v·ªõi ai?",
              opts: [
                { text: "Th·∫ßy c√¥, anh ch·ªã ƒëi tr∆∞·ªõc (ng∆∞·ªùi gi√∫p ƒë·ª° b·∫°n trong h·ªçc t·∫≠p)", score: 3 },
                { text: "B·∫°n b√® x√£ giao, quan h·ªá b√¨nh th∆∞·ªùng", score: 1 },
                { text: "Kh√¥ng k·∫øt n·ªëi th√™m ai ƒë·∫∑c bi·ªát", score: -1 }
              ]
            },
            // Q2: Relationship Building
            { q: "Ho·∫°t ƒë·ªông n√†y c√≥ gi√∫p b·∫°n x√¢y d·ª±ng m·ªëi quan h·ªá b·∫°n mu·ªën kh√¥ng?",
              opts: [
                { text: "C√≥, c·∫ßn thi·∫øt cho h·ªçc t·∫≠p.", score: 3 },
                { text: "C√≥, c·∫ßn thi·∫øt cho vi·ªác k·∫øt b·∫°n vui ch∆°i.", score: 2 },
                { text: "Kh√¥ng h·∫≥n, ch·ªâ l√† duy tr√¨ m·ªëi quan h·ªá s·∫µn c√≥.", score: 1 },
                { text: "Kh√¥ng ch·∫Øc, ch∆∞a x√°c ƒë·ªãnh ƒë·ªëi t∆∞·ª£ng c·ª• th·ªÉ.", score: 0 }
              ]
            },
            // Q3: FOMO
            { q: "N·∫øu b·∫°n kh√¥ng ƒëi, b·∫°n c√≥ c·∫£m gi√°c ti·∫øc th·∫≠t s·ª± kh√¥ng, hay ch·ªâ s·ª£ m·ªçi ng∆∞·ªùi ƒëi m√† b·∫°n kh√¥ng ƒëi?",
              opts: [
                { text: "R·∫•t ti·∫øc, c∆° h·ªôi duy nh·∫•t/ l·ªõn gi√∫p √≠ch vi·ªác h·ªçc.", score: 3 },
                { text: "Ch·ªâ b·ªã FOMO, s·ª£ b·ªè l·ª° c√°i g√¨ ƒë√≥ hay ho c√≥ th·ªÉ x·∫£y ra.", score: -2 },
                { text: "Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c.", score: 0 }
              ]
            },
            // Q4: Motivation
            { q: "B·∫°n c√≥ mu·ªën tham gia ngay c·∫£ khi kh√¥ng ai r·ªß?",
              opts: [
                { text: "C√≥, v√¨ mang l·∫°i l·ª£i √≠ch cho b·∫£n th√¢n.", score: 2 },
                { text: "Ch·∫Øc l√† kh√¥ng ƒëi, ƒëi m·ªôt m√¨nh bu·ªìn ch√°n l·∫Øm.", score: -2 },
                { text: "Ch∆∞a ch·∫Øc n·ªØa, ƒëi·ªÅu ki·ªán thu·∫≠n l·ª£i th√¨ c√≥ th·ªÉ ƒëi.", score: 0 }
              ]
            },
            // Q5: Affordability
            { q: "Sau khi tham gia, s·ªë ti·ªÅn c√≤n l·∫°i c·ªßa b·∫°n c√≥ ƒë·ªß s·ªëng s√≥t qua th·ªùi gian c√≤n l·∫°i kh√¥ng?",
              opts: [
                { text: "C√≥ th·ªÉ, c√≤n l·∫°i tr√™n 50% chi ph√≠ sinh ho·∫°t th√°ng.", score: 1 },
                { text: "Ch·∫Øc l√† kh√¥ng, c√≤n l·∫°i d∆∞·ªõi 20% chi ph√≠ sinh ho·∫°t th√°ng.", score: -3 },
                { text: "C≈©ng c√≥ th·ªÉ, c√≤n l·∫°i 20%-50% chi ph√≠ sinh ho·∫°t th√°ng.", score: 0 }
              ]
            },
            // Q6: Stress Relief/Value
            { q: "N√≥ c√≥ gi√∫p b·∫°n gi·∫£i t·ªèa stress hay mang l·∫°i gi√° tr·ªã tinh th·∫ßn kh√¥ng?",
              opts: [
                { text: "C√≥, n√≥ r·∫•t th√∫ v·ªã.", score: 2 },
                { text: "Kh√¥ng, t√¥i nghƒ© n√≥ s·∫Ω ch√°n.", score: -1 },
                { text: "Ch∆∞a tham gia n√™n c≈©ng ch∆∞a bi·∫øt n·ªØa.", score: 0 }
              ]
            },
            // Q7: Feel Better
            { q: "ƒêi c√≥ gi√∫p b·∫°n c·∫£m th·∫•y t·ªët h∆°n th·∫≠t kh√¥ng?",
              opts: [
                { text: "C√≥, s·ª± ki·ªán n√†y c√≥ m·ª•c ƒë√≠ch r√µ r√†ng.", score: 2 },
                { text: "Kh√¥ng ch·∫Øc l·∫Øm, ch∆∞a ch·∫Øc s·∫Ω hi·ªáu qu·∫£.", score: 0 }
              ]
            },
            // Q8: Study Impact
            { q: "ƒêi xong b·∫°n c√≥ b·ªã ·∫£nh h∆∞·ªüng h·ªçc t·∫≠p ho·∫∑c l·ªãch tr√¨nh kh√¥ng?",
              opts: [
                { text: "C√≥, b·ªã ·∫£nh h∆∞·ªüng (kh√¥ng k·ªãp l√†m b√†i t·∫≠p, tr√πng l·ªãch kh√°c)", score: -2 },
                { text: "Kh√¥ng, kh√¥ng b·ªã ·∫£nh h∆∞·ªüng", score: 1 }
              ]
            },
            // Q9: Long-term Memory
            { q: "Tham gia ho·∫°t ƒë·ªông n√†y c√≥ gi√∫p b·∫°n t·∫°o k·ª∑ ni·ªám hay m·ªëi quan h·ªá l√¢u d√†i kh√¥ng?",
              opts: [
                { text: "C√≥ th·ªÉ, t·∫°o ra k·ªâ ni·ªám ƒë·∫πp v·ªõi nh·ªØng m·ªëi quan h·ªá m·ªõi.", score: 2 },
                { text: "Kh√¥ng, ch·ªâ l√† tr·∫£i nghi·ªám vui v·∫ª t·∫°m th·ªùi.", score: -1 }
              ]
            },
            // Q10: Alternatives
            { q: "C√≥ c√°ch n√†o tham gia v·ªõi chi ph√≠ th·∫•p h∆°n kh√¥ng?",
              opts: [
                { text: "C√≥, c√≥ th·ªÉ ƒëi chung xe v·ªõi b·∫°n, kh√¥ng mua th√™m qu√† b√°nh n∆∞·ªõc,...", score: 2 },
                { text: "Kh√¥ng, chi ph√≠ ƒë√£ c·ªë ƒë·ªãnh.", score: -1 }
              ]
            }
        ];


        // --- H√ÄM H·ªñ TR·ª¢ HI·ªÇN TH·ªä ---

        function addPocketPalMessage(content, type = 'info') {
            const chatArea = document.getElementById('chatArea');
            let contentClass = 'bg-gray-100 pocket-pal-text-blue'; 
            let contentStyle = 'font-normal';
            
            if (type === 'question' || type === 'quiz_q') {
                contentClass = 'bg-gray-100 pocket-pal-text-blue';
                contentStyle = 'font-bold';
            } else if (type === 'conclusion') {
                contentClass = 'bg-blue-100 pocket-pal-text-blue font-bold';
            }

            const messageHtml = `
                <div class="flex flex-col items-start">
                    <div class="text-sm font-semibold mb-1 text-gray-500">Pocket Pal</div>
                    <div class="max-w-xs md:max-w-md p-3 rounded-xl rounded-tl-none shadow-md ${contentClass}">
                        <p class="text-sm leading-relaxed ${contentStyle}">${content}</p>
                    </div>
                </div>
            `;
            chatArea.insertAdjacentHTML('beforeend', messageHtml);
            chatArea.scrollTop = chatArea.scrollHeight; 
        }

        function addUserResponse(text) {
            const chatArea = document.getElementById('chatArea');
            const messageHtml = `
                <div class="flex flex-col items-end">
                    <div class="text-sm font-semibold mb-1 text-gray-500">B·∫°n</div>
                    <div class="max-w-xs md:max-w-md bg-green-500 text-white p-3 rounded-xl rounded-tr-none shadow-md">
                        <p class="text-sm leading-relaxed">${text}</p>
                    </div>
                </div>
            `;
            chatArea.insertAdjacentHTML('beforeend', messageHtml);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function renderOptions(options, handler) {
            const inputArea = document.getElementById('inputArea');
            inputArea.innerHTML = '';
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex flex-col space-y-2';
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option.text;
                button.className = 'w-full btn-primary text-white font-normal py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition ease-in-out duration-150';
                button.onclick = () => handler(option.value, option.text);
                buttonContainer.appendChild(button);
            });
            inputArea.appendChild(buttonContainer);
        }

        function renderEmailInput() {
            const inputArea = document.getElementById('inputArea');
            inputArea.innerHTML = `
                <div id="emailMessage" class="pocket-pal-text-blue mb-3 font-semibold text-center">H√£y nh·∫≠p email c·ªßa b·∫°n v√†o ƒë√¢y</div>
                <input type="email" id="emailInput" placeholder="Nh·∫≠p email c·ªßa b·∫°n..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                <button id="emailSubmitBtn" class="w-full btn-primary text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition ease-in-out duration-150">
                    G·ª≠i cho Pocket Pal
                </button>
            `;
            document.getElementById('emailSubmitBtn').onclick = submitEmail;
        }

        function showResultModal(message) {
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('resultModal').classList.remove('hidden');
            document.getElementById('resultModal').classList.add('flex');
            document.getElementById('modalCloseBtn').onclick = () => {
                document.getElementById('resultModal').classList.remove('flex');
                document.getElementById('resultModal').classList.add('hidden');
                // CHUY·ªÇN SANG H·ªéI XEM C√ì MU·ªêN B·∫ÆT ƒê·∫¶U L·∫†I KH√îNG
                appState = 'ask_restart';
                renderChatbox();
            };
        }

        function resetChat() {
            appState = 'intro';
            userSelection = {};
            quizScore = 0;
            quizMode = '';
            currentQuizIndex = 0;
            document.getElementById('chatArea').innerHTML = ''; // X√≥a to√†n b·ªô n·ªôi dung chat
            renderChatbox();
        }

        // --- LOGIC X·ª¨ L√ù TR·∫†NG TH√ÅI ---

        function handleAnswer(value, text, score = 0) {
            const chatArea = document.getElementById('chatArea');
            const questionMessageElement = chatArea.lastElementChild; 

            // 1. Th√™m c√¢u tr·∫£ l·ªùi c·ªßa ng∆∞·ªùi d√πng v√†o giao di·ªán
            addUserResponse(text); 

            // 2. X√≥a tin nh·∫Øn Pocket Pal (c√¢u h·ªèi) v·ª´a ƒë∆∞·ª£c tr·∫£ l·ªùi
            if (questionMessageElement) {
                questionMessageElement.remove();
            }

            // --- Logic Quiz ---
            if (appState.startsWith('quiz')) {
                quizScore += score;
                currentQuizIndex++;
                if (appState.includes('buying') && currentQuizIndex < QUIZ_BUYING.length) {
                    renderQuizQuestion(QUIZ_BUYING[currentQuizIndex], 'buying');
                    return;
                } else if (appState.includes('event') && currentQuizIndex < QUIZ_EVENT.length) {
                    renderQuizQuestion(QUIZ_EVENT[currentQuizIndex], 'event');
                    return;
                } else {
                    appState = appState.replace('quiz_', 'result_');
                    renderChatbox();
                    return;
                }
            }

            // --- Chuy·ªÉn tr·∫°ng th√°i ---
            switch (appState) {
                case 'intro':
                    appState = (value === 'manage') ? 'branch1_q1' : 'branch2_q1';
                    break;
                case 'branch1_q1':
                    appState = (value === 'simple') ? 'branch1_1_info' : 'branch1_2_info';
                    break;
                case 'branch1_email_q1':
                    appState = (value === 'yes') ? 'branch1_email_q2' : 'ask_restart'; // Chuy·ªÉn sang h·ªèi restart n·∫øu ch·ªçn No
                    break;
                case 'branch1_email_q2':
                    userSelection.style = text;
                    appState = 'branch1_email_input';
                    break;
                case 'branch2_q1':
                    appState = (value === 'buying') ? 'branch2_1_q1' : 'branch2_2_q1';
                    break;
                case 'branch2_1_q1':
                    quizMode = value;
                    appState = 'quiz_buying';
                    currentQuizIndex = 0;
                    break;
                case 'branch2_2_q1':
                    quizMode = value;
                    appState = 'quiz_event';
                    currentQuizIndex = 0;
                    break;
                case 'ask_restart':
                    if (value === 'yes') {
                        resetChat();
                        return; // NgƒÉn kh√¥ng cho ch·∫°y renderChatbox() b√™n d∆∞·ªõi
                    } else {
                        appState = 'conclusion';
                    }
                    break;
            }
            renderChatbox();
        }

        function renderQuizQuestion(quizData, quizType) {
            addPocketPalMessage(`(C√¢u ${currentQuizIndex + 1}/10) ${quizData.q}`, 'quiz_q');

            const options = quizData.opts.map(option => {
                let score = 0;
                if (quizType === 'buying') {
                    score = option.scores[quizMode];
                } else if (quizType === 'event') {
                    score = option.score;
                }
                
                // Tr·∫£ v·ªÅ text v√† gi√° tr·ªã, score ƒë∆∞·ª£c ·∫©n trong value ƒë·ªÉ handleAnswer() l·∫•y
                return {
                    text: option.text,
                    value: JSON.stringify({ text: option.text, score: score })
                };
            });

            // Handler ƒë·∫∑c bi·ªát cho Quiz ƒë·ªÉ truy·ªÅn ƒëi·ªÉm
            const quizHandler = (jsonValue, text) => {
                const data = JSON.parse(jsonValue);
                handleAnswer(text, data.text, data.score);
            };

            renderOptions(options, quizHandler);
        }

        async function submitEmail() {
            const emailInput = document.getElementById('emailInput');
            const email = emailInput.value.trim();
            const submitBtn = document.getElementById('emailSubmitBtn');
            
            if (!email || !email.includes('@')) {
                document.getElementById('emailMessage').textContent = "Vui l√≤ng nh·∫≠p m·ªôt email h·ª£p l·ªá!";
                document.getElementById('emailMessage').classList.add('text-red-500');
                return;
            }

            submitBtn.textContent = 'ƒêang g·ª≠i...';
            submitBtn.disabled = true;

            // Trong m√¥i tr∆∞·ªùng Apps Script, b·∫°n c·∫ßn d√πng google.script.run ƒë·ªÉ g·ªçi h√†m server-side
            // Tuy nhi√™n, v√¨ ƒë√¢y l√† demo ch·ªâ g·ª≠i email, ch√∫ng ta s·∫Ω gi·∫£ l·∫≠p th√†nh c√¥ng
            // N·∫øu b·∫°n mu·ªën t√≠ch h·ª£p g·ª≠i email th·ª±c s·ª±, b·∫°n c·∫ßn t·∫°o h√†m server-side trong Code.gs
            // V√≠ d·ª• v·ªÅ c·∫•u tr√∫c h√†m gi·∫£ l·∫≠p:
            try {
                // Gi·∫£ l·∫≠p g·ª≠i th√†nh c√¥ng
                await new Promise(resolve => setTimeout(resolve, 1500)); 
                
                document.getElementById('emailMessage').textContent = "Pocket Pal ƒë√£ l∆∞u l·∫°i email v√† s·∫Ω nh·∫Øc b·∫°n s·ªõm th√¥i!";
                document.getElementById('emailMessage').classList.remove('text-red-500');
            } catch (error) {
                console.error('L·ªói khi g·ª≠i email (gi·∫£ l·∫≠p):', error);
                document.getElementById('emailMessage').textContent = "L·ªói m·∫°ng ho·∫∑c k·∫øt n·ªëi, nh∆∞ng Pocket Pal v·∫´n c·∫£m ∆°n b·∫°n!";
                document.getElementById('emailMessage').classList.add('text-red-500');
            } finally {
                submitBtn.textContent = 'Ho√†n t·∫•t';
                submitBtn.disabled = false;
                // Chuy·ªÉn sang h·ªèi restart sau khi ho√†n th√†nh lu·ªìng email
                appState = 'ask_restart';
                renderChatbox();
            }
        }

        // --- H√ÄM RENDER CH√çNH ---

        function renderChatbox() {
            const inputArea = document.getElementById('inputArea');
            inputArea.innerHTML = '';

            switch (appState) {
                case 'intro':
                    addPocketPalMessage("Ch√†o b·∫°n, m√¨nh l√† Pocket Pal, m·ªôt chatbox ƒë∆∞·ª£c t·∫°o b·ªüi nh√≥m sinh vi√™n tr∆∞·ªùng ƒê·∫°i h·ªçc Ngo·∫°i th∆∞∆°ng CSII nh·∫±m gi√∫p ƒë·ª° b·∫°n c√°c v·∫•n ƒë·ªÅ v·ªÅ chi ti√™u m√† b·∫°n ƒëang m·∫Øc ph·∫£i.");
                    setTimeout(() => {
                        addPocketPalMessage("B·∫°n mu·ªën m√¨nh gi√∫p ƒë·ª° ƒëi·ªÅu g√¨?", 'question');
                        renderOptions([
                            { text: "Cung c·∫•p prompt gi√∫p m√¨nh gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ v·ªÅ c√°ch qu·∫£n l√≠ ti·ªÅn b·∫°c c·ªßa m√¨nh.", value: 'manage' },
                            { text: "Gi√∫p m√¨nh ƒë∆∞a ra quy·∫øt ƒë·ªãnh chi ti√™u", value: 'decision' }
                        ], handleAnswer);
                    }, 500);
                    break;

                // --- BRANCH 1: QU·∫¢N L√ù TI·ªÄN B·∫†C ---
                case 'branch1_q1':
                    addPocketPalMessage("B·∫°n th∆∞·ªùng qu·∫£n l√Ω chi ti√™u theo c√°ch n√†o?", 'question');
                    renderOptions([
                        { text: "T√¥i ∆∞u ti√™n s·ª± ƒë∆°n gi·∫£n, th∆∞·ªùng ch·ªâ mu·ªën bi·∫øt t·ªïng s·ªë ti·ªÅn m√¨nh c√≥ th·ªÉ s·ª≠ d·ª•ng m√† kh√¥ng ph·∫£i ghi ch√©p nhi·ªÅu.", value: 'simple' },
                        { text: "T√¥i mu·ªën n·∫Øm r√µ chi ti√™u h√†ng th√°ng, th√≠ch theo d√µi chi ti·∫øt ƒë·ªÉ t·ªëi ∆∞u t·ª´ng kho·∫£n.", value: 'detail' }
                    ], handleAnswer);
                    break;

                case 'branch1_1_info': // Simple Methods
                    addPocketPalMessage(`
                        Pocket Pal nghƒ© r·∫±ng b·∫°n ph√π h·ª£p v·ªõi hai ph∆∞∆°ng ph√°p qu·∫£n l√Ω chi ti√™u sau:
                        <br><br>
                        <strong class="text-lg">üëâ Ph∆∞∆°ng ph√°p 80/20</strong>
                        <br>
                        80% cho to√†n b·ªô chi ti√™u thi·∫øt y·∫øu + chi ti√™u linh ho·∫°t.
                        <br>
                        20% cho ti·∫øt ki·ªám ho·∫∑c tr·∫£ n·ª£.
                        <br>
                        <em class="text-xs">ƒê√¢y l√† c√°ch qu·∫£n l√Ω t·ªëi gi·∫£n, d·ªÖ √°p d·ª•ng v√† ph√π h·ª£p v·ªõi ng∆∞·ªùi th√≠ch s·ª± ƒë∆°n gi·∫£n.</em>
                        <br><br>
                        <strong class="text-base pocket-pal-text-blue">üëâ Prompt b·∫°n c√≥ th·ªÉ d√πng v·ªõi Chat GPT/Gemini/DeepSeek:</strong>
                        <br>
                        T√¥i ƒëang c√≥ s·ªë ti·ªÅn: [S·ªê TI·ªÄN], s·ª≠ d·ª•ng trong [S·ªê TH√ÅNG] th√°ng.
                        H√£y gi√∫p t√¥i chia kho·∫£n ti·ªÅn n√†y theo quy t·∫Øc 80/20. H√£y cho t√¥i bi·∫øt s·ªë ti·ªÅn c·ª• th·ªÉ cho 80% (chi ti√™u) v√† 20% (ti·∫øt ki·ªám/tr·∫£ n·ª£), v√† ƒë∆∞a ra l·ªùi khuy√™n t·ªëi ∆∞u n·∫øu kho·∫£n ti·ªÅn t√¥i c√≥ ch∆∞a ph√π h·ª£p v·ªõi m√¥ h√¨nh n√†y.
                        <br><br>
                        <strong class="text-lg">üëâ Ph∆∞∆°ng ph√°p 70/20/10</strong>
                        <br>
                        70% chi ti√™u h·∫±ng th√°ng
                        <br>
                        20% ti·∫øt ki·ªám/ƒë·∫ßu t∆∞
                        <br>
                        10% ph√°t tri·ªÉn b·∫£n th√¢n
                        <br>
                        <em class="text-xs">C√°ch l√†m n√†y v·ª´a ƒë∆°n gi·∫£n v·ª´a gi√∫p b·∫°n c√≥ s·ª± c√¢n b·∫±ng gi·ªØa chi ti√™u ‚Äì ti·∫øt ki·ªám ‚Äì ph√°t tri·ªÉn c√° nh√¢n.</em>
                        <br><br>
                        <strong class="text-base pocket-pal-text-blue">üëâ Prompt b·∫°n c√≥ th·ªÉ d√πng v·ªõi Chat GPT/Gemini/DeepSeek:</strong>
                        <br>
                        T√¥i ƒëang c√≥ s·ªë ti·ªÅn: [S·ªê TI·ªÄN], s·ª≠ d·ª•ng trong [S·ªê TH√ÅNG] th√°ng.
                        H√£y gi√∫p t√¥i chia kho·∫£n ti·ªÅn n√†y theo quy t·∫Øc 70/20/10 v·ªõi 70% chi ti√™u, 20% ti·∫øt ki·ªám/ƒë·∫ßu t∆∞, v√† 10% ph√°t tri·ªÉn b·∫£n th√¢n. H√£y t√≠nh s·ªë ti·ªÅn c·ª• th·ªÉ cho t·ª´ng m·ª•c v√† g·ª£i √Ω ƒëi·ªÅu ch·ªânh n·∫øu c·∫ßn.
                    `, 'info');
                    appState = 'branch1_email_q1';
                    setTimeout(renderChatbox, 500);
                    break;

                case 'branch1_2_info': // Detailed Methods
                    addPocketPalMessage(`
                        Pocket Pal nghƒ© r·∫±ng b·∫°n ph√π h·ª£p v·ªõi c√°c ph∆∞∆°ng ph√°p qu·∫£n l√Ω chi ti√™u chi ti·∫øt sau:
                        <br><br>
                        <strong class="text-lg">üëâ Ph∆∞∆°ng ph√°p 50/30/20 (N√¢ng Cao)</strong>
                        <br>
                        50% nhu c·∫ßu thi·∫øt y·∫øu (nh√† ·ªü, ƒÉn u·ªëng, ƒëi·ªán n∆∞·ªõc‚Ä¶)
                        <br>
                        30% mong mu·ªën (mua s·∫Øm, gi·∫£i tr√≠‚Ä¶)
                        <br>
                        20% ti·∫øt ki·ªám/ƒë·∫ßu t∆∞
                        <br>
                        <em class="text-xs">Phi√™n b·∫£n n√¢ng cao c√≤n chia nh·ªè t·ª´ng m·ª•c ƒë·ªÉ ki·ªÉm so√°t chi ti·∫øt h∆°n, r·∫•t h·ª£p v·ªõi ng∆∞·ªùi th√≠ch theo d√µi s√°t sao chi ti√™u.</em>
                        <br><br>
                        <strong class="text-base pocket-pal-text-blue">üëâ Prompt b·∫°n c√≥ th·ªÉ d√πng v·ªõi Chat GPT/Gemini/DeepSeek:</strong>
                        <br>
                        T√¥i ƒëang c√≥ s·ªë ti·ªÅn: [S·ªê TI·ªÄN], s·ª≠ d·ª•ng trong [S·ªê TH√ÅNG] th√°ng. H√£y gi√∫p t√¥i chia kho·∫£n ti·ªÅn n√†y theo m√¥ h√¨nh 50/30/20 n√¢ng cao. Ngo√†i 3 nh√≥m ch√≠nh (thi·∫øt y·∫øu ‚Äì mong mu·ªën ‚Äì ti·∫øt ki·ªám), h√£y chia nh·ªè t·ª´ng nh√≥m th√†nh c√°c danh m·ª•c chi ti√™u c·ª• th·ªÉ v√† g·ª£i √Ω c√°ch theo d√µi ƒë·ªÉ t·ªëi ∆∞u chi ti√™u h·∫±ng th√°ng.
                        <br><br>
                        <strong class="text-lg">üëâ Ph∆∞∆°ng ph√°p 6 Chi·∫øc L·ªç (JARS System)</strong>
                        <br>
                        M√¥ h√¨nh 6 h≈© chia thu nh·∫≠p th√†nh: NEC ‚Äì FFA ‚Äì LTSS ‚Äì EDU ‚Äì PLAY ‚Äì GIVE.
                        <br>
                        <em class="text-xs">Ph∆∞∆°ng ph√°p n√†y c·ª±c chi ti·∫øt v√† gi√∫p ng∆∞·ªùi d√πng c√≥ c√°i nh√¨n r√µ r√†ng v·ªÅ m·ªçi m·∫∑t trong cu·ªôc s·ªëng t√†i ch√≠nh.</em>
                        <br><br>
                        <strong class="text-base pocket-pal-text-blue">üëâ Prompt b·∫°n c√≥ th·ªÉ d√πng v·ªõi ChatGPT/Gemini/DeepSeek:</strong>
                        <br>
                        T√¥i ƒëang c√≥ s·ªë ti·ªÅn: [S·ªê TI·ªÄN], s·ª≠ d·ª•ng trong [S·ªê TH√ÅNG] th√°ng. H√£y gi√∫p t√¥i ph√¢n b·ªï kho·∫£n ti·ªÅn n√†y theo ph∆∞∆°ng ph√°p 6 chi·∫øc l·ªç (NEC, FFA, LTSS, EDU, PLAY, GIVE). H√£y ghi r√µ s·ªë ti·ªÅn c·ª• th·ªÉ cho t·ª´ng l·ªç v√† gi·∫£i th√≠ch vai tr√≤ c·ªßa m·ªói l·ªç ƒë·ªÉ t√¥i d·ªÖ theo d√µi.
                        <br><br>
                        <strong class="text-lg">üëâ Ph∆∞∆°ng ph√°p Zero-Based Budgeting (ZBB)</strong>
                        <br>
                        Y√™u c·∫ßu ph√¢n b·ªï t·ª´ng ƒë·ªìng ƒë·∫øn ƒë√∫ng m·ªôt m·ª•c ƒë√≠ch. T·ªïng chi ti√™u = T·ªïng s·ªë ti·ªÅn b·∫°n c√≥.
                        <br>
                        <em class="text-xs">R·∫•t ph√π h·ª£p cho ng∆∞·ªùi mu·ªën ki·ªÉm so√°t ch√≠nh x√°c v√† t·ªëi ∆∞u h√≥a chi ti√™u.</em>
                        <br><br>
                        <strong class="text-base pocket-pal-text-blue">üëâ Prompt b·∫°n c√≥ th·ªÉ d√πng v·ªõi ChatGPT/Gemini/DeepSeek:</strong>
                        <br>
                        T√¥i ƒëang c√≥ s·ªë ti·ªÅn: [S·ªê TI·ªÄN], s·ª≠ d·ª•ng trong [S·ªê TH√ÅNG] th√°ng. H√£y √°p d·ª•ng ph∆∞∆°ng ph√°p Zero-Based Budgeting ƒë·ªÉ ph√¢n b·ªï to√†n b·ªô kho·∫£n ti·ªÅn n√†y. H√£y chia nh·ªè t·ª´ng lo·∫°i chi ti√™u v√† ƒë·∫£m b·∫£o t·ªïng chi ti√™u b·∫±ng ƒë√∫ng s·ªë ti·ªÅn t√¥i c√≥. ƒê∆∞a ra ƒë·ªÅ xu·∫•t t·ªëi ∆∞u n·∫øu c√≥ danh m·ª•c v∆∞·ª£t m·ª©c c·∫ßn thi·∫øt.
                    `, 'info');
                    appState = 'branch1_email_q1';
                    setTimeout(renderChatbox, 500);
                    break;

                case 'branch1_email_q1':
                    addPocketPalMessage("B·∫°n c√≥ mu·ªën Pocket Pal nh·∫Øc b·∫°n m·ªói ng√†y v·ªÅ vi·ªác ghi ch√©p chi ti√™u kh√¥ng?", 'question');
                    renderOptions([
                        { text: "C√≥", value: 'yes' },
                        { text: "Kh√¥ng", value: 'no' }
                    ], handleAnswer);
                    break;

                case 'branch1_email_q2':
                    addPocketPalMessage("B·∫°n mu·ªën m√¨nh ƒë√≥ng vai tr√≤ n√†o?", 'question');
                    renderOptions([
                        { text: "Th√¢n thi·ªán, g·∫ßn g≈©i.", value: 'friendly' },
                        { text: "Nghi√™m kh·∫Øc.", value: 'strict' }
                    ], handleAnswer);
                    break;

                case 'branch1_email_input':
                    addPocketPalMessage("H√£y nh·∫≠p email c·ªßa b·∫°n v√†o ƒë√¢y", 'question');
                    renderEmailInput();
                    break;

                // --- BRANCH 2: QUY·∫æT ƒê·ªäNH CHI TI√äU ---
                case 'branch2_q1':
                    addPocketPalMessage("B·∫°n ƒëang ph√¢n v√¢n trong v·∫•n ƒë·ªÅ g√¨?", 'question');
                    renderOptions([
                        { text: "M√¨nh ph√¢n v√¢n trong vi·ªác c√≥ n√™n mua g√¨ ƒë√≥ kh√¥ng.", value: 'buying' },
                        { text: "M√¨nh ph√¢n v√¢n trong vi·ªác c√≥ n√™n tham gia s·ª± ki·ªán ƒë√≥ kh√¥ng.", value: 'event' }
                    ], handleAnswer);
                    break;

                // Branch 2.1 - Buying Quiz Setup
                case 'branch2_1_q1':
                    addPocketPalMessage("Hi·ªán t·∫°i nhu c·∫ßu chi ti√™u c·ªßa b·∫°n l√† g√¨?", 'question');
                    renderOptions([
                        { text: "T√¥i c·∫ßn si·∫øt ch·∫∑t chi ti√™u.", value: 'tight' },
                        { text: "T√¥i mu·ªën ti·∫øt ki·ªám h∆°n.", value: 'save' },
                        { text: "T√¥i d∆∞ d·∫£ nh∆∞ng mu·ªën qu·∫£n l√Ω chi ti√™u h·ª£p l√Ω h∆°n.", value: 'comfort' }
                    ], handleAnswer);
                    break;

                // Branch 2.2 - Event Quiz Setup
                case 'branch2_2_q1':
                    addPocketPalMessage("T√¨nh tr·∫°ng kinh t·∫ø hi·ªán t·∫°i c·ªßa b·∫°n nh∆∞ th·∫ø n√†o?", 'question');
                    renderOptions([
                        { text: "M√¨nh kh√¥ng c·∫ßn qu√° ti·∫øt ki·ªám.", value: 'moderate' },
                        { text: "M√¨nh ƒëang s·ªëng d∆∞ d·∫£, kh√¥ng √°p l·ª±c ti·ªÅn b·∫°c.", value: 'rich' },
                        { text: "M√¨nh th·∫≠t s·ª± c·∫ßn ti·∫øt ki·ªám.", value: 'strict' }
                    ], handleAnswer);
                    break;

                // --- QUIZ EXECUTION ---
                case 'quiz_buying':
                    renderQuizQuestion(QUIZ_BUYING[currentQuizIndex], 'buying');
                    break;
                case 'quiz_event':
                    renderQuizQuestion(QUIZ_EVENT[currentQuizIndex], 'event');
                    break;

                // --- QUIZ RESULTS ---
                case 'result_buying':
                    let buyingResultText = "";
                    const scoreBuying = quizScore;
                    
                    if (quizMode === 'tight') { // Si·∫øt ch·∫∑t chi ti√™u
                        if (scoreBuying >= 10) {
                            buyingResultText = "<strong>N√äN MUA</strong><br>ƒê√¢y l√† m·ªôt kho·∫£n chi c·∫ßn thi·∫øt v√† h·ª£p l√Ω. B·∫°n c√≥ th·ªÉ mua n√≥.";
                        } else if (scoreBuying >= 1 && scoreBuying <= 9) {
                            buyingResultText = "<strong>C√ÇN NH·∫ÆC TH√äM</strong><br>H√£y c√¢n nh·∫Øc th·∫≠t k·ªπ. T·ªët nh·∫•t b·∫°n n√™n ƒë·ª£i 24-48 gi·ªù tr∆∞·ªõc khi quy·∫øt ƒë·ªãnh.";
                        } else { // scoreBuying <= 0
                            buyingResultText = "<strong>KH√îNG N√äN MUA</strong><br>Kh√¥ng n√™n mua l√∫c n√†y. M√≥n ƒë·ªì n√†y c√≥ th·ªÉ ·∫£nh h∆∞·ªüng ƒë·∫øn k·∫ø ho·∫°ch t√†i ch√≠nh c·ªßa b·∫°n.";
                        }
                    } else if (quizMode === 'save') { // Mu·ªën ti·∫øt ki·ªám h∆°n
                        if (scoreBuying >= 10) {
                            buyingResultText = "<strong>N√äN MUA</strong><br>B·∫°n ƒë√£ c√¢n nh·∫Øc kh√° k·ªπ v√† m√≥n ƒë·ªì n√†y mang l·ª£i √≠ch r√µ r√†ng, v·∫≠y th√¨ ch·ªù g√¨ n·ªØa n√≠! B·∫°n ho√†n to√†n c√≥ th·ªÉ mua n√®!";
                        } else if (scoreBuying >= 5 && scoreBuying <= 9) {
                            buyingResultText = "<strong>C√ÇN NH·∫ÆC TH√äM</strong><br>H√£y c√¢n nh·∫Øc th·∫≠t k·ªπ tr∆∞·ªõc khi mua m√≥n ƒë·ªì n√†y, b·∫°n c√≥ th·ªÉ ƒë·ª£i th√™m m·ªôt th·ªùi gian r·ªìi h·∫µng quy·∫øt ƒë·ªãnh nh√©!";
                        } else { // scoreBuying < 5
                            buyingResultText = "<strong>KH√îNG N√äN MUA</strong><br>D·ª±a tr√™n c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n, m√≥n n√†y ch∆∞a th·ª±c s·ª± c·∫ßn thi·∫øt v√† c√≥ th·ªÉ khi·∫øn b·∫°n m·∫•t ki·ªÉm so√°t chi ti√™u. B·∫°n kh√¥ng n√™n mua l√∫c n√†y,... h·∫øt c·ª©u ƒë√≥!";
                        }
                    } else if (quizMode === 'comfort') { // D∆∞ d·∫£
                        if (scoreBuying >= 12) {
                            buyingResultText = "<strong>N√äN MUA</strong><br>B·∫°n ho√†n to√†n c√≥ th·ªÉ mua. Quy·∫øt ƒë·ªãnh n√†y h·ª£p l√Ω v·ªõi m·ª•c ti√™u qu·∫£n l√Ω chi ti√™u c·ªßa b·∫°n.";
                        } else if (scoreBuying >= 4 && scoreBuying <= 11) {
                            buyingResultText = "<strong>C√ÇN NH·∫ÆC TH√äM</strong><br>C√≥ th·ªÉ mua, nh∆∞ng b·∫°n n√™n c√¢n nh·∫Øc ho·∫∑c ƒë·ª£i 24 gi·ªù ƒë·ªÉ xem c√≥ c√≤n mu·ªën n·ªØa kh√¥ng.";
                        } else { // scoreBuying <= 3
                            buyingResultText = "<strong>KH√îNG N√äN MUA</strong><br>Kh√¥ng n√™n mua. M√≥n n√†y kh√¥ng mang l·∫°i l·ª£i √≠ch t∆∞∆°ng x·ª©ng v√† d·ªÖ d·∫´n ƒë·∫øn chi ti√™u kh√¥ng hi·ªáu qu·∫£.";
                        }
                    }

                    showResultModal(buyingResultText);
                    break;

                case 'result_event':
                    let eventResultText = "";
                    const scoreEvent = quizScore;
                    
                    if (quizMode === 'moderate') { // Kh√¥ng c·∫ßn qu√° ti·∫øt ki·ªám (Moderate)
                        if (scoreEvent >= 8) {
                            eventResultText = "<strong>N√äN THAM GIA</strong><br>ƒê√¢y l√† ho·∫°t ƒë·ªông mang l·∫°i gi√° tr·ªã ƒë·ªß l·ªõn so v·ªõi chi ph√≠ v√† th·ªùi gian.";
                        } else { // scoreEvent < 8
                            eventResultText = "<strong>KH√îNG N√äN THAM GIA</strong><br>Chi ph√≠ (ti·ªÅn/th·ªùi gian/nƒÉng l∆∞·ª£ng) v∆∞·ª£t qu√° l·ª£i √≠ch.";
                        }
                    } else if (quizMode === 'rich') { // S·ªëng d∆∞ d·∫£ (Rich)
                        if (scoreEvent >= 4) {
                            eventResultText = "<strong>N√äN THAM GIA</strong><br>ƒê√¢y l√† ho·∫°t ƒë·ªông mang l·∫°i gi√° tr·ªã ƒë·ªß l·ªõn so v·ªõi chi ph√≠ v√† th·ªùi gian.";
                        } else { // scoreEvent < 4
                            eventResultText = "<strong>KH√îNG N√äN THAM GIA</strong><br>Chi ph√≠ (ti·ªÅn/th·ªùi gian/nƒÉng l∆∞·ª£ng) v∆∞·ª£t qu√° l·ª£i √≠ch.";
                        }
                    } else if (quizMode === 'strict') { // Th·∫≠t s·ª± c·∫ßn ti·∫øt ki·ªám (Strict)
                        if (scoreEvent >= 12) {
                            eventResultText = "<strong>N√äN THAM GIA</strong><br>ƒê√¢y l√† ho·∫°t ƒë·ªông mang l·∫°i gi√° tr·ªã ƒë·ªß l·ªõn so v·ªõi chi ph√≠ v√† th·ªùi gian.";
                        } else { // scoreEvent < 12
                            eventResultText = "<strong>KH√îNG N√äN THAM GIA</strong><br>Chi ph√≠ (ti·ªÅn/th·ªùi gian/nƒÉng l∆∞·ª£ng) v∆∞·ª£t qu√° l·ª£i √≠ch.";
                        }
                    }

                    showResultModal(eventResultText);
                    break;

                // --- H·ªéI RESTART ---
                case 'ask_restart':
                    addPocketPalMessage("Pocket Pal c·∫£m ∆°n b·∫°n ƒë√£ tr√≤ chuy·ªán. B·∫°n c√≥ mu·ªën b·∫Øt ƒë·∫ßu l·∫°i cu·ªôc tr√≤ chuy·ªán v√† kh√°m ph√° c√°c t√πy ch·ªçn kh√°c kh√¥ng?", 'question');
                    renderOptions([
                        { text: "C√≥, m√¨nh mu·ªën b·∫Øt ƒë·∫ßu l·∫°i", value: 'yes' },
                        { text: "Kh√¥ng, t·∫°m bi·ªát Pocket Pal", value: 'no' }
                    ], handleAnswer);
                    break;

                // --- K·∫æT TH√öC CU·ªòC TR√í CHUY·ªÜN ---
                case 'conclusion':
                    addPocketPalMessage("Pocket Pal c·∫£m ∆°n b·∫°n r·∫•t nhi·ªÅu, hi v·ªçng g·ª£i √Ω c·ªßa m√¨nh ƒë√£ gi√∫p ƒë·ª° b·∫°n ph·∫ßn n√†o trong vi·ªác qu·∫£n l√Ω chi ti√™u. T·∫°m bi·ªát v√† h·∫πn g·∫∑p l·∫°i b·∫°n!", 'conclusion');
                    // X√≥a khu v·ª±c input
                    inputArea.innerHTML = '';
                    break;

                default:
                    addPocketPalMessage("ƒê√£ x·∫£y ra l·ªói trong lu·ªìng tr√≤ chuy·ªán. Vui l√≤ng t·∫£i l·∫°i trang ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i.", 'conclusion');
                    break;
            }
        }

        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
        document.addEventListener('DOMContentLoaded', () => {
            renderChatbox();
        });
    </script>
</body>
</html>
